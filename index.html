<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width" />
	<meta name="format-detection" content="telephone=no" />
	<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;" />
	<title>360</title>
	<link rel="stylesheet" href="css/reset.css" media="screen" type="text/css" />
	<link rel="stylesheet" href="css/360view.css" media="screen" type="text/css" />
</head>
<body>
	<div id="spinner" class="preloader"></div>
	<div id="threesixty_view" class="threesixty_view_wrapper"></div>
	
	<script src="js/heartcode-canvasloader-min.js"></script>
	<script src="js/jquery-1.6.4.min.js"></script>
	<script>
	
	$(document).ready(function () {
		var cl, enabled = false, threesixty = $("#threesixty_view"), pointers = ["mouse", "finger"], pointer = "", dragging = false; sequence_name = "img/rob_###.jpg", totalFrames = 180, currentFrame = 0, endFrame = 0, pointerStartPosX = 0, pointerEndPosX = 0, pointerDistance = 0, monitorStartTime = 0, monitorInt = 10, pointerSpeed = 0, friction = 0.8, ticker = 0, loadedImages = 0;
		
		/**
		*
		*/
		function showThreesixty () {
			$("#threesixty_view").fadeIn("slow");
			endFrame = 359;
			refresh();
		};
		
		/**
		* 
		*/
		function resetImages () {
			for (var i = totalFrames; i > 0; i--) {
				$("#threesixty_view img:eq(" + i + ")").remove();
			}
			$("#threesixty_view img:eq(0)").css("visibility", "visible");
		};
		
		/**
		* 
		*/
		function imageLoaded() {
			++loadedImages;
			if (loadedImages == totalFrames) {
				resetImages();
				$("#spinner").fadeOut("slow", function(){ cl.hide(); showThreesixty(); });
			}
		};
		
		/**
		* 
		*/
		function addImages() {
			
			var ol = document.createElement("ol");
			for (var i = 0; i < totalFrames; i++) {
				var id = i < 10 ? "00" + i.toString() : i.toString();
				if (i >= 10 && i < 100) {
					id = "0" + i.toString();
				}
				var imageName = sequence_name.split("###").join(id);
				var li = ol.appendChild(document.createElement("li"));
				var img = li.appendChild(document.createElement("img"));
				img.setAttribute("src", imageName);
				
				$(img).load(function() {
					imageLoaded();
				});
			}
			
			document.getElementById("threesixty_view").appendChild(ol);
		};
		
		/**
		*
		*/
		function addSpinner () {
			cl = new CanvasLoader("spinner");
			cl.setDiameter(30);
			cl.setDensity(60);
			cl.setRange(1);
			cl.setColor("#333333");
			cl.setFPS(32);
			cl.show();
		};
		
		function init () {
			addSpinner();
			$("#spinner").hide().fadeIn("slow");
			$("#threesixty_view").hide();
			addImages();
		};
		
		init();
		
		
		
		
		/**
		*
		*/
		function swapImages() {
			var c = Math.ceil((currentFrame * -0.5) % (totalFrames - 1));
			if (c < 0) c += (totalFrames-1);
			var id = c < 10 ? "00" + c.toString() : c.toString();
			if (c >= 10 && c < 100) {
				id = "0" + c.toString();
			}
			var imageName = sequence_name.split("###").join(id);
			$("#threesixty_view img:eq(0)").attr("src", imageName);
		};
		
		/**
		*
		*/
		$("#threesixty_view").live("touchstart", function (event) {
			event.preventDefault();
			pointer = pointers[1];
			startPointerTracking(event);
		});
		
		/**
		*
		*/
		$("#threesixty_view").live("touchmove", function (event) {
			event.preventDefault();
			trackPointer(event);
		});
		
		/**
		*
		*/
		$("#threesixty_view").live("touchend", function (event) {
			event.preventDefault();
			stopPointerTracking(event);
		});
		
		/**
		*
		*/
		$("#threesixty_view").mousedown(function (event) {
			event.preventDefault();
			pointer = pointers[0];
			startPointerTracking(event);
		});
		
		$(document).mouseup(function (event){
			event.preventDefault();
			stopPointerTracking(event);
		});
		/**
		*
		*/
		$(document).mousemove(function (event){	
			event.preventDefault();
			trackPointer(event);
		});
		/**
		*
		* @param event {Object}
		*/
		function startPointerTracking (event) {
			dragging = true;
			pointerStartPosX = pointer === pointers[0] ? event.pageX : event.originalEvent.targetTouches[0].pageX;
			monitorStartTime = new Date().getTime();
		};
		
		/**
		*
		*/
		function stopPointerTracking (event) {
			dragging = false;
			pointerEndPosX = pointer === pointers[0] ? event.pageX : event.originalEvent.targetTouches[0].pageX;
			calculatePointerSpeed();
		};
		
		/**
		* 
		*/
		function trackPointer(event) {
			if (dragging) {
				pointerEndPosX = pointer === pointers[0] ? event.pageX : event.originalEvent.targetTouches[0].pageX;
				
				if(monitorStartTime < new Date().getTime() - monitorInt) {
					monitorStartTime = new Date().getTime();
					calculatePointerSpeed();
					refresh();
					pointerStartPosX = pointer === pointers[0] ? event.pageX : event.originalEvent.targetTouches[0].pageX;
					if(!dragging) {
						endFrame = currentFrame + Math.ceil((totalFrames - 1) * 10 * (pointerDistance / $("#threesixty_view").width()) * pointerSpeed);
					} else {
						endFrame = currentFrame + Math.ceil((totalFrames - 1) * 10 *(pointerDistance / $("#threesixty_view").width()));
					}
				}
			}
		};
		
		function calculatePointerSpeed() {
			pointerDistance = pointerEndPosX - pointerStartPosX;
			pointerSpeed = pointerDistance / monitorInt;
		};
		
		function refresh () {
			if (ticker === 0) {
				ticker = self.setInterval(function () { render(); }, Math.round(1000 / 60));
			}
		};
		
		function render () {
			if(currentFrame !== endFrame)
			{	
				currentFrame += Math.ceil((endFrame - currentFrame) * 0.1);
				swapImages();
			} else {
				window.clearInterval(ticker);
				ticker = 0;
			}
		};
	});
	
	</script>
</body>
</html>